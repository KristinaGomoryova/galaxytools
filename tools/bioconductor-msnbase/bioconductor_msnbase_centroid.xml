<tool id="bioconductor_msnbase_centroid" name="bioconductor-msnbase centroid" version="@TOOL_VERSION@+galaxy@VERSION_SUFFIX@" profile="20.01" license="MIT">
    <description>centroid raw profile-mode MS data</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="xrefs"/>
    <expand macro="creator"/>
    <expand macro="requirements"/>
    <command detect_errors="exit_code"><![CDATA[
        Rscript -e 'source("${run_script}")'
    ]]></command>
    <configfiles>
        <configfile name="run_script"><![CDATA[
            data_prof <- MSnbase::readMSData("$input_file", msLevel = $mslevel)

            data_centroided <- MSnbase::pickPeaks(
                data_prof,
                halfWindowSize = ${halfWindowSize},
                method = "${estimate_noise_method}",
                SNR = ${snr},
                refineMz = "${refinement.method}",
                #if "$refinement.method" == "kNeighbors"
                k = ${refinement.k}
                #else if "$refinement.method" == "descendPeak"
                signalPercentage = ${refinement.signal_percentage},
                stopAtTwo = ${refinement.stop_at_two}
                #end if
            )

            MSnbase::writeMSData(
                data_centroided,
                file = "centroided.mzml",
                copy = TRUE,
                outformat = "mzml"
            )
        ]]></configfile>
    </configfiles>
    <inputs>
        <param name="input_file" type="data" format="mzml" label="Input mzML File" help="The input mzML file containing the MS data."/>
        <param argument="mslevel" type="boolean" truevalue="2" falsevalue="1" checked="false" label="MS2" help="Does the dataset contain MS2 data?" />
        <param name="halfWindowSize" type="integer" label="Half window size" min="1" value="2" help="The window size parameter for the centroiding method."/>
        <param name="estimate_noise_method" type="select" label="Noise estimation method" help="Method to choose to estimate the noise in the spectrum.">
            <option value="MAD" selected="true">Median Absolute Deviation</option>
            <option value="SuperSmoother">Friedman's Super Smoother</option>
        </param>
        <param argument="--snr" type="float" min="0" value="3" label="Signal-to-noise ratio (SNR)" help="Signal-to-noise ratio to remove noisy signal." />
        <conditional name="refinement">
            <param name="method" type="select" label="Peak refinement method" 
                help="The method refines the m/z value of the identified centroids by considering data points that belong (most likely) to the same mass peak.
                The m/z value is calculated as an intensity weighted average of the m/z values within the peak region.
                How the peak region is defined depends on the method chosen.">
                <option value="none" selected="true">None</option>
                <option value="kNeighbors">K-Neighbors</option>
                <option value="descendPeak">Descend Peak</option>
            </param>
            <when value="kNeighbors">
                <param argument="--k" type="integer" min="1" max="10" value="2" label="K" help="Number of 2*K nearest neighbours for mz interpolation." />
            </when>
            <when value="descendPeak">
                <param argument="--signal_percentage" type="integer" min="0" max="100" value="20" label="Intensity threshold (%)" help="Signal intensity cutoff threshold for including values in mz calculation." />
                <param argument="stop_at_two" type="boolean" truevalue="TRUE" falsevalue="FALSE" checked="false" label="Stop at two" help="Stop the descend only once two increasing scans are encountered instead of at the first encounter." />
            </when>
            <when value="none"/>
        </conditional>
    </inputs>
    <outputs>
        <data name="output_file" format="mzml" label="${on_string} centroided" from_work_dir="centroided.mzml"/>
    </outputs>
    <tests>
        <test>
            <param name="input_file" value="29_qc_no_dil_milliq_subset.mzML"/>
            <output name="output_file" file="test_output_centroided.mzml" lines_diff="10"/>
        </test>
    </tests>
    <help><![CDATA[

.. class:: infomark

**What it does**

TODO: Fill in help in reStructuredText format (https://docutils.sourceforge.io/docs/ref/rst/restructuredtext.html)

Usage
.....


**Input**


**Output**


    ]]></help>
        <expand macro="citations"/>
</tool>