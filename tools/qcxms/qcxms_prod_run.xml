<tool id="qcxms_production_run" name="QCxMS production run" version="@TOOL_VERSION@+galaxy1" profile="21.05">
    <description>Production run to obtain a QCxMS simulated mass spectrum</description>
    
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="edam"/>
    <expand macro="creator"/>
    <expand macro="requirements"/>

    <command detect_errors="exit_code"><![CDATA[
        python3 '${create_folder_structure}' &&
        find TMPQCXMS/*/ -type d | xargs -I {} -P \${GALAXY_SLOTS:-1} sh -c 'cd {} && /qcxms_bin/qcxms --prod >> $log' &&
        /qcxms_bin/getres &&
        /plotms_bin/PlotMS.v.6.2.0/plotms &&
        sh ${__tool_directory__}/msp_out.sh
    ]]></command>

    <environment_variables>
        <environment_variable name="OMP_NUM_THREADS">1,2,1</environment_variable>
    </environment_variables>

    <configfiles>
        <configfile name="create_folder_structure">
import os
import shutil

#set in_collection = str("', '").join([str($f) for $f in $in_files])
#set start_collection = str("', '").join([str($f) for $f in $start_files])
#set xyz_collection = str("', '").join([str($f) for $f in $xyz_files])

#set names = str("', '").join([str($f.name) for $f in $xyz_files])
names = '$names'
folder_names = [x.split("_")[0] for x in names]

in_collection = '$in_collection'
start_collection = '$start_collection'
xyz_collection = '$xyz_collection'

# Create a new output folder to store the result
output_path = 'TMPQCXMS'
os.makedirs(output_path, exist_ok=True)

for folder_name, in_file, start_file, xyz_file in zip(folder_names, in_collection, start_collection, xyz_collection):
    new_folder_path = os.path.join(output_path, folder_name)
    os.makedirs(new_folder_path, exist_ok=True)

    shutil.copy2(os.path.join(os.path.dirname(in_collection[0]), in_file), os.path.join(new_folder_path, 'qcxms.in'))
    shutil.copy2(os.path.join(os.path.dirname(start_collection[0]), start_file), os.path.join(new_folder_path, 'qcxms.start'))
    shutil.copy2(os.path.join(os.path.dirname(xyz_collection[0]), xyz_file), os.path.join(new_folder_path, 'start.xyz'))

        </configfile>
    </configfiles>

    <inputs>
        <param type="data_collection" collection_type="list" name="in_files" label="in files [.in]" format="in,txt,text"/>
        <param type="data_collection" collection_type="list" name="start_files" label="start files [.start]" format="start,txt,text"/>
        <param type="data_collection" collection_type="list" name="xyz_files" label="xyz files [.xyz]" format="xyz,txt,text"/>
        <param name="store_extended_output" type="boolean" value="false" label="Store additional outputs" help="Output the logfile."/>
    </inputs>

    <outputs>
        <data name="msp_output" format="msp" from_work_dir="simulated_spectra.msp" label="simulated_spectra.msp generated by ${tool.name} on ${on_string}"/>
        <data name="log" format="txt" label="logfile of ${tool.name} on ${on_string}">
            <filter>store_extended_output</filter>
        </data>
    </outputs>

    <tests>
        <test expect_failure="true"/>
    </tests>

    <help><![CDATA[
        The QCxMS production run tool is used to simulate mass spectra for a given molecule using the QCxMS (Quantum Chemistry by Mass Spectrometry) method. 
        This tool generates simulated mass spectra based on the equilibrium structure of a molecule and allows you to perform QCxMS production runs.
        For detail information visit the documentation at https://xtb-docs.readthedocs.io/en/latest/qcxms_doc/qcxms_run.html#excecuting-the-production-runs
        ]]>
    </help>

    <citations>
        <citation type="doi">10.1002/anie.201300158</citation>
        <citation type="doi">10.1039/C4OB01668H</citation>
        <citation type="doi">10.1021/jp5096618</citation>
        <citation type="doi">10.1255/ejms.1313</citation>
        <citation type="doi">10.1021/acs.jpca.6b02907</citation>
    </citations>
</tool>
