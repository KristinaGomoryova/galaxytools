<tool id="mfassignr_mfassign" name="MFAssignR MFAssign" version="1.0.3+galaxy0">
    <description>Molecular formula assignment.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="creator" />
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript -e 'source("${run_script}")'
    ]]></command>
    <configfiles>
        <configfile name="run_script"><![CDATA[
        mono <- read.delim("$input_mono", sep="\t")
        #if $input_iso
        iso <- read.delim("$input_iso", sep="\t")
        #end if
        SN = $sn_ratio * $kmdn

        MF_assign <- MFAssignR::MFAssign(
            peaks = mono,
            #if $input_iso
            isopeaks = iso,
            #end if
            ionMode = "$ionmode",
            lowMW = $lowMW,
            highMW = $highMW,
            ppm_err = $ppm_err,
            SN = SN
        )

        write.table(MF_assign[['Unambig']], file = '$Unambig', row.names= FALSE, sep = "\t")
        write.table(MF_assign[['Ambig']], file = '$Ambig', row.names= FALSE, sep = "\t")
        write.table(MF_assign[['None']], file = '$None', row.names= FALSE, sep = "\t")

        dir.create("plots")
        ggplot2::ggsave(filename = file.path("plots", "msassign.png"), MF_assign[['MSAssign']])
        ggplot2::ggsave(filename = file.path("plots", "errorMZ.png"), MF_assign[['Error']])
        ggplot2::ggsave(filename = file.path("plots", "MSgroups.png"), MF_assign[['MSgroups']])
        ggplot2::ggsave(filename = file.path("plots", "VK.png"), MF_assign[['VK']])

        ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="mfassign_param"/>
    </inputs>
    <outputs>
        <data name="Unambig" format="tabular" label="Unambiguous assignments by ${tool.name} on ${on_string}"/>
        <data name="Ambig" format="tabular" label="Ambiguous assignments by ${tool.name} on ${on_string}"/>
        <data name="None" format="tabular" label="Unassigned masses by ${tool.name} on ${on_string}"/>
        <collection format="png" type="list" name="plots" label="Plots generated by ${tool.name} on ${on_string}">
            <discover_datasets pattern="__designation_and_ext__" ext="png" directory="plots" />
        </collection>
    </outputs>
    <tests>
        <test expect_failure="true"/>
    </tests>
    <help><![CDATA[
    MFAssign function assigns the molecular formula to input dataframe, where the first column is mass, second intensity and third column usually retention time. It can be used to assign MF with 12C, 1H, and 16O and a variety of heteroatoms and isotopes, including 2H, 13C, 14N, 15N, 31P, 32S, 34S, 35Cl, 37Cl, 19F, 79Br, 81Br, and 126I. It can also assign Na+ adducts, which are common in positive ion mode.
    ]]></help>
    <expand macro="citations" />
</tool>