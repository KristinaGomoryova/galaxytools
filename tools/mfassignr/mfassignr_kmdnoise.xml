<tool id="mfassignr_kmdnoise" name="MFAssignR KMDNoise" version="1.0.3+galaxy0">
    <description>Noise level assessment using the KMDNoise.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="creator" />
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript -e 'source("${run_script}")'
    ]]></command>
    <configfiles>
        <configfile name="run_script"><![CDATA[
        df <- read.delim("$input_file", sep="\t")
        assess_noise <- MFAssignR::KMDNoise(
            df = df,
            upper.y = $upper_y,
            lower.y = $lower_y,
            #if $upper_x
            upper.x = $upper_x,
            #end if
            #if $lower_x
            lower.x = $lower_x
            #end if
        )
        noise <- assess_noise[['Noise']]
        write.table(noise, file = '$Noise', row.names= FALSE, col.names = FALSE)
        ggplot2::ggsave(filename = "KMDplot.png", assess_noise[['KMD']])
        ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="kmdnoise_param"/>
    </inputs>
    <outputs>
        <data name="Noise" format="txt" label="Noise level estimate by ${tool.name} on ${on_string}"/>
        <data name="KMD_plot" format="png" label="KMD plot" from_work_dir="KMDplot.png"/>
    </outputs>
    <tests>
        <test expect_failure="true"/>
    </tests>
    <help><![CDATA[
    KMDnoise is a Kendrick Mass Defect (KMD) approach for the noise estimation. It selects a subset of the data using the linear equation y=0.1132x + b, where y stands for the KMD value, x for the measured ion mass and b is the y-intercept. The default y-intercepts of 0.05 and 0.2 in KMDNoise are used to isolate the largest analyte free region of noise in most mass spectra. The intensity of the peaks within this “slice” are then averaged and that value is defined as the noise level for the mass spectrum. This value is then multiplied with a user-defined signal-to-noise ratio (typically 3-10) to remove low intensity m/z values.
    ]]></help>
    <expand macro="citations" />
</tool>