<tool id="mfassignr_recal" name="MFAssignR Recal" version="1.0.3+galaxy0">
    <description>Internal Mass Recalibration.</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="creator" />
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        Rscript -e 'source("${run_script}")'
    ]]></command>
    <configfiles>
        <configfile name="run_script"><![CDATA[
            df <- read.delim("$input_file", sep="\t")
            peaks <- read.delim("$peaks", sep="\t")
            SN <- $sn_ratio * $kmdn

            series <- read.delim('$series', sep='\t')

            recal <- MFAssignR::Recal(
                df = df,
                peaks = peaks,
                #if $isopeaks
                isopeaks = read.delim("$isopeaks", sep="\t"),
                #end if
                mode = "$ionmode",
                SN = SN,
                mzRange = $mzRange,
                step_O = $step_O,
                step_H2 = $step_H2,
                CalPeak = $CalPeak,
                series1 = series[1, "Series"],
                series2 = series[2, "Series"],
                series3 = series[3, "Series"],
                series4 = series[4, "Series"],
                series5 = series[5, "Series"],
                series6 = series[6, "Series"],
                series7 = series[7, "Series"],
                series8 = series[8, "Series"],
                series9 = series[9, "Series"],
                series10 = series[10, "Series"]
            )

            write.table(recal[['Mono']], file = '$Mono', row.names= FALSE, sep="\t")
            write.table(recal[['Iso']], file = '$Iso', row.names= FALSE, sep="\t")
            write.table(recal[['RecalList']], file = '$RecalList', row.names= FALSE, sep="\t")
            ggplot2::ggsave(filename = "MZplot.png", recal[['Plot']])

        ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="recal_param"/>
    </inputs>
    <outputs>
        <data name="Mono" format="tabular" label="Recalibrated 'Mono' list by ${tool.name} on ${on_string}"/>
        <data name="Iso" format="tabular" label="Recalibrated 'Iso' list by ${tool.name} on ${on_string}"/>
        <data name="RecalList" format="tabular" label="Recalibrants list (RecalOut) by ${tool.name} on ${on_string}"/>
        <data name="MZplot" format="png" label="MZ plot by ${tool.name} on ${on_string}" from_work_dir="MZplot.png"/>
    </outputs>
    <tests>
        <test expect_failure="true"/>
    </tests>
    <help><![CDATA[
        Recal() function recalibrates the 'Mono' and 'Iso' outputs from the IsoFiltR() function and prepares a dataframe containing chose recalibrants. Also it outputs a plot for the qualitative assessment of recalibrants. The input to the function is output from MFAssign() or MFAssignCHO(). 

        This function can handle up to 10 homologous series, though it will work with fewer. It is important for recalibrant masses to cover the entire mass range of interest, and they should be among the most abundant peaks in their region of the spectrum, this function helps with visualizing the recalibrants.
    ]]></help>
    <expand macro="citations" />
</tool>